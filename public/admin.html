<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Newsletter Tracker - Admin Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f8f9fa;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            background: white;
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .header h1 {
            color: #2c3e50;
            margin-bottom: 10px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            text-align: center;
        }

        .stat-number {
            font-size: 2em;
            font-weight: bold;
            color: #3498db;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #7f8c8d;
            font-size: 0.9em;
        }

        .subscribers-section {
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .section-header {
            background: #34495e;
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-box {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            width: 250px;
        }

        .export-btn {
            background: #27ae60;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
        }

        .export-btn:hover {
            background: #229954;
        }

        .table-container {
            max-height: 600px;
            overflow-y: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }

        th {
            background: #f8f9fa;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        tr:hover {
            background: #f8f9fa;
        }

        .status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            font-weight: 500;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-confirmed {
            background: #d4edda;
            color: #155724;
        }

        .view-details-btn {
            background: #007bff;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .view-details-btn:hover {
            background: #0056b3;
        }

        .delete-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .delete-btn:hover {
            background: #c82333;
        }

        .restore-btn {
            background: #28a745;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
            margin-right: 5px;
        }

        .restore-btn:hover {
            background: #218838;
        }

        .permanent-delete-btn {
            background: #6c757d;
            color: white;
            border: none;
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8em;
        }

        .permanent-delete-btn:hover {
            background: #5a6268;
        }

        .view-tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            border-bottom: 2px solid #eee;
        }

        .tab-btn {
            background: none;
            border: none;
            padding: 10px 20px;
            cursor: pointer;
            font-size: 1em;
            border-bottom: 3px solid transparent;
            color: #666;
        }

        .tab-btn.active {
            color: #007bff;
            border-bottom-color: #007bff;
        }

        .tab-btn:hover {
            color: #007bff;
        }

        .checkbox-column {
            width: 40px;
            text-align: center;
        }

        .bulk-actions {
            background: #f8f9fa;
            padding: 15px 20px;
            border-bottom: 1px solid #eee;
            display: none;
            align-items: center;
            gap: 15px;
        }

        .bulk-actions.show {
            display: flex;
        }

        .selection-count {
            color: #007bff;
            font-weight: 500;
        }

        .bulk-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9em;
            margin-right: 10px;
        }

        .bulk-btn:hover {
            background: #c82333;
        }

        .bulk-btn.restore {
            background: #28a745;
        }

        .bulk-btn.restore:hover {
            background: #218838;
        }

        .bulk-btn.permanent {
            background: #6c757d;
        }

        .bulk-btn.permanent:hover {
            background: #5a6268;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
        }

        .modal-content {
            background: white;
            margin: 5% auto;
            padding: 20px;
            border-radius: 8px;
            width: 90%;
            max-width: 800px;
            max-height: 80%;
            overflow-y: auto;
        }

        .close {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close:hover {
            color: black;
        }

        .detail-section {
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 6px;
        }

        .detail-section h3 {
            margin-bottom: 10px;
            color: #2c3e50;
        }

        .detail-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }

        .detail-item {
            display: flex;
            justify-content: space-between;
            padding: 5px 0;
            border-bottom: 1px solid #eee;
        }

        .event-item {
            background: white;
            padding: 10px;
            margin: 5px 0;
            border-radius: 4px;
            border-left: 4px solid #3498db;
        }

        .loading {
            text-align: center;
            padding: 20px;
            color: #7f8c8d;
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .detail-grid {
                grid-template-columns: 1fr;
            }
            
            .search-box {
                width: 100%;
                margin-bottom: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>Newsletter Tracker Dashboard</h1>
            <p>Monitor subscriber activity and behavioral data</p>
        </div>

        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-number" id="totalSubscribers">-</div>
                <div class="stat-label">Total Subscribers</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="newThisWeek">-</div>
                <div class="stat-label">New This Week</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="totalEvents">-</div>
                <div class="stat-label">Total Events Tracked</div>
            </div>
            <div class="stat-card">
                <div class="stat-number" id="avgEngagement">-</div>
                <div class="stat-label">Avg Events per User</div>
            </div>
        </div>

        <!-- View Tabs -->
        <div class="view-tabs">
            <button class="tab-btn active" onclick="switchView('active')">Active Subscribers</button>
            <button class="tab-btn" onclick="switchView('trash')">üóëÔ∏è Trash Can</button>
        </div>

        <div class="subscribers-section">
            <div class="section-header">
                <h2 id="sectionTitle">Active Subscribers</h2>
                <div>
                    <input type="text" class="search-box" id="searchBox" placeholder="Search by email or name...">
                    <button class="export-btn" onclick="syncAllStatuses()" style="background: #007bff; margin-right: 10px;" id="syncBtn">Sync Shopify</button>
                    <button class="export-btn" onclick="exportData()">Export CSV</button>
                </div>
            </div>
            
            <!-- Bulk Actions Bar -->
            <div class="bulk-actions" id="bulkActions">
                <span class="selection-count" id="selectionCount">0 selected</span>
                <div>
                    <button class="bulk-btn" onclick="bulkDeleteSelected()" id="bulkDeleteBtn">Delete Selected</button>
                    <button class="bulk-btn restore" onclick="bulkRestoreSelected()" id="bulkRestoreBtn" style="display: none;">Restore Selected</button>
                    <button class="bulk-btn permanent" onclick="bulkPermanentDeleteSelected()" id="bulkPermanentBtn" style="display: none;">Permanently Delete Selected</button>
                    <button class="bulk-btn" onclick="clearSelection()" style="background: #6c757d;">Clear Selection</button>
                </div>
            </div>
            
            <div class="table-container">
                <table id="subscribersTable">
                    <thead>
                        <tr>
                            <th>Email</th>
                            <th>Name</th>
                            <th>Status</th>
                            <th>Joined</th>
                            <th>Device</th>
                            <th>Location</th>
                            <th>Events</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody id="subscribersBody">
                        <tr>
                            <td colspan="8" class="loading">Loading subscribers...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Subscriber Details Modal -->
    <div id="detailsModal" class="modal">
        <div class="modal-content">
            <span class="close">&times;</span>
            <h2>Subscriber Details</h2>
            <div id="modalContent">
                <div class="loading">Loading details...</div>
            </div>
        </div>
    </div>

    <script>
        let allSubscribers = [];
        let filteredSubscribers = [];
        let currentView = 'active'; // 'active' or 'trash'
        let selectedSubscribers = new Set(); // Track selected subscriber IDs

        // Load dashboard data
        async function loadDashboard() {
            try {
                let endpoint = currentView === 'active' ? '/api/admin/subscribers' : '/api/admin/subscribers/trash';
                
                // Only sync Shopify statuses for active subscribers
                if (currentView === 'active') {
                    await syncAllShopifyStatuses();
                }
                
                const response = await fetch(endpoint);
                const result = await response.json();
                
                if (result.success) {
                    allSubscribers = result.data;
                    filteredSubscribers = [...allSubscribers];
                    updateStats();
                    renderSubscribersTable();
                } else {
                    showError('Failed to load subscribers data');
                }
            } catch (error) {
                console.error('Error loading dashboard:', error);
                showError('Network error occurred');
            }
        }

        // Switch between active and trash views
        function switchView(view) {
            currentView = view;
            
            // Update tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            // Update section title
            const sectionTitle = document.getElementById('sectionTitle');
            const syncBtn = document.getElementById('syncBtn');
            
            if (view === 'active') {
                sectionTitle.textContent = 'Active Subscribers';
                syncBtn.style.display = 'inline-block';
            } else {
                sectionTitle.textContent = 'üóëÔ∏è Trash Can';
                syncBtn.style.display = 'none';
            }
            
            // Clear search and selection
            document.getElementById('searchBox').value = '';
            selectedSubscribers.clear();
            
            // Load appropriate data
            loadDashboard();
        }

        // Toggle individual subscriber selection
        function toggleSubscriberSelection(subscriberId) {
            if (selectedSubscribers.has(subscriberId)) {
                selectedSubscribers.delete(subscriberId);
            } else {
                selectedSubscribers.add(subscriberId);
            }
            updateSelectionUI();
        }

        // Toggle select all
        function toggleSelectAll() {
            const selectAllCheckbox = document.getElementById('selectAll');
            
            if (selectAllCheckbox.checked) {
                // Select all filtered subscribers
                filteredSubscribers.forEach(subscriber => {
                    selectedSubscribers.add(subscriber.id);
                });
            } else {
                // Deselect all
                selectedSubscribers.clear();
            }
            
            updateSelectionUI();
            renderSubscribersTable(); // Re-render to update checkboxes
        }

        // Update selection UI
        function updateSelectionUI() {
            const selectedCount = selectedSubscribers.size;
            const selectionCountElement = document.getElementById('selectionCount');
            const bulkActionsElement = document.getElementById('bulkActions');
            const bulkDeleteBtn = document.getElementById('bulkDeleteBtn');
            const bulkRestoreBtn = document.getElementById('bulkRestoreBtn');
            const bulkPermanentBtn = document.getElementById('bulkPermanentBtn');
            
            // Update selection count
            selectionCountElement.textContent = selectedCount === 0 ? '0 selected' : 
                selectedCount === 1 ? '1 subscriber selected' : `${selectedCount} subscribers selected`;
            
            // Show/hide bulk actions bar
            if (selectedCount > 0) {
                bulkActionsElement.classList.add('show');
                
                // Show appropriate buttons based on current view
                if (currentView === 'active') {
                    bulkDeleteBtn.style.display = 'inline-block';
                    bulkRestoreBtn.style.display = 'none';
                    bulkPermanentBtn.style.display = 'none';
                } else {
                    bulkDeleteBtn.style.display = 'none';
                    bulkRestoreBtn.style.display = 'inline-block';
                    bulkPermanentBtn.style.display = 'inline-block';
                }
            } else {
                bulkActionsElement.classList.remove('show');
            }
            
            // Update select all checkbox state
            const selectAllCheckbox = document.getElementById('selectAll');
            if (selectAllCheckbox) {
                const visibleSubscriberIds = filteredSubscribers.map(s => s.id);
                const allVisibleSelected = visibleSubscriberIds.length > 0 && 
                    visibleSubscriberIds.every(id => selectedSubscribers.has(id));
                
                selectAllCheckbox.checked = allVisibleSelected;
                selectAllCheckbox.indeterminate = !allVisibleSelected && 
                    visibleSubscriberIds.some(id => selectedSubscribers.has(id));
            }
        }

        // Clear selection
        function clearSelection() {
            selectedSubscribers.clear();
            updateSelectionUI();
            renderSubscribersTable();
        }

        // Helper functions for behavioral analysis
        function formatTimeSpent(milliseconds) {
            if (!milliseconds) return 'Unknown';
            const seconds = Math.round(milliseconds / 1000);
            if (seconds < 60) return `${seconds}s`;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            return remainingSeconds > 0 ? `${minutes}m ${remainingSeconds}s` : `${minutes}m`;
        }

        function renderBehavioralAnalysis(behavioral, pageViews) {
            const stats = analyzeBehavioralData(behavioral, pageViews);
            
            return `
                <div class="detail-section">
                    <h3>üìà Behavioral Summary</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span>Total Interactions:</span>
                            <span>${stats.totalInteractions}</span>
                        </div>
                        <div class="detail-item">
                            <span>Page Views:</span>
                            <span>${stats.pageViews}</span>
                        </div>
                        <div class="detail-item">
                            <span>Clicks:</span>
                            <span>${stats.clicks}</span>
                        </div>
                        <div class="detail-item">
                            <span>Product Interactions:</span>
                            <span>${stats.productInteractions}</span>
                        </div>
                        <div class="detail-item">
                            <span>Cart Actions:</span>
                            <span>${stats.cartActions}</span>
                        </div>
                        <div class="detail-item">
                            <span>Checkout Events:</span>
                            <span>${stats.checkoutEvents}</span>
                        </div>
                        <div class="detail-item">
                            <span>Average Time per Page:</span>
                            <span>${stats.avgTimePerPage}</span>
                        </div>
                        <div class="detail-item">
                            <span>Engagement Level:</span>
                            <span style="color: ${getEngagementColor(stats.engagementLevel)}">${stats.engagementLevel}</span>
                        </div>
                    </div>
                </div>
            `;
        }

        function analyzeBehavioralData(behavioral, pageViews) {
            const clicks = behavioral.filter(e => e.event_type === 'click').length;
            const productInteractions = behavioral.filter(e => e.event_type === 'product_interaction' || e.event_type === 'product_view').length;
            const cartActions = behavioral.filter(e => e.event_type === 'cart_action').length;
            const checkoutEvents = behavioral.filter(e => e.event_type === 'checkout_step').length;
            
            // Calculate average time per page
            const timeSpentEvents = pageViews.filter(pv => pv.time_spent > 0);
            const avgTime = timeSpentEvents.length > 0 
                ? timeSpentEvents.reduce((sum, pv) => sum + pv.time_spent, 0) / timeSpentEvents.length
                : 0;
            
            // Determine engagement level
            const totalInteractions = behavioral.length;
            let engagementLevel = 'Low';
            if (totalInteractions > 20 || productInteractions > 5 || cartActions > 0) {
                engagementLevel = 'High';
            } else if (totalInteractions > 10 || productInteractions > 2) {
                engagementLevel = 'Medium';
            }

            return {
                totalInteractions,
                pageViews: pageViews.length,
                clicks,
                productInteractions,
                cartActions,
                checkoutEvents,
                avgTimePerPage: formatTimeSpent(avgTime),
                engagementLevel
            };
        }

        function getEngagementColor(level) {
            switch(level) {
                case 'High': return '#28a745';
                case 'Medium': return '#ffc107';
                case 'Low': return '#dc3545';
                default: return '#6c757d';
            }
        }

        function renderCategorizedEvents(behavioral) {
            const categories = {
                'E-commerce': ['product_view', 'product_interaction', 'cart_action', 'checkout_step'],
                'Navigation': ['click', 'page_view', 'scroll'],
                'Engagement': ['hover', 'input_focus', 'form_submission'],
                'Other': []
            };

            let html = '';
            
            for (const [category, eventTypes] of Object.entries(categories)) {
                const categoryEvents = behavioral.filter(event => 
                    eventTypes.includes(event.event_type)
                );
                
                if (categoryEvents.length > 0) {
                    html += `
                        <div style="margin-bottom: 20px;">
                            <h4 style="color: #007bff; margin-bottom: 10px;">${getCategoryIcon(category)} ${category} (${categoryEvents.length})</h4>
                            ${categoryEvents.map(event => renderEvent(event)).join('')}
                        </div>
                    `;
                }
            }

            // Add uncategorized events
            const categorizedTypes = Object.values(categories).flat();
            const otherEvents = behavioral.filter(event => 
                !categorizedTypes.includes(event.event_type)
            );
            
            if (otherEvents.length > 0) {
                html += `
                    <div style="margin-bottom: 20px;">
                        <h4 style="color: #007bff; margin-bottom: 10px;">üîß Other Events (${otherEvents.length})</h4>
                        ${otherEvents.map(event => renderEvent(event)).join('')}
                    </div>
                `;
            }

            return html;
        }

        function getCategoryIcon(category) {
            switch(category) {
                case 'E-commerce': return 'üõí';
                case 'Navigation': return 'üß≠';
                case 'Engagement': return 'üëÜ';
                default: return 'üîß';
            }
        }

        function renderEvent(event) {
            const eventData = event.event_data ? JSON.parse(event.event_data) : {};
            const icon = getEventIcon(event.event_type);
            
            return `
                <div class="event-item" style="margin-bottom: 8px;">
                    <strong>${icon} ${formatEventType(event.event_type)}</strong> - ${new Date(event.timestamp).toLocaleString()}
                    <br>
                    <small>üìç Page: ${event.page_url}</small>
                    ${renderEventDetails(event.event_type, eventData)}
                </div>
            `;
        }

        function getEventIcon(eventType) {
            const icons = {
                'click': 'üëÜ',
                'hover': 'üñ±Ô∏è',
                'product_view': 'üëÅÔ∏è',
                'product_interaction': 'üì¶',
                'cart_action': 'üõí',
                'checkout_step': 'üí≥',
                'search': 'üîç',
                'form_submission': 'üìù',
                'input_focus': '‚úèÔ∏è',
                'scroll': 'üìú',
                'page_view': 'üìÑ',
                'time_spent': '‚è±Ô∏è',
                'visibility_change': 'üëÅÔ∏è‚Äçüó®Ô∏è'
            };
            return icons[eventType] || 'üìä';
        }

        function formatEventType(eventType) {
            return eventType.split('_').map(word => 
                word.charAt(0).toUpperCase() + word.slice(1)
            ).join(' ');
        }

        function renderEventDetails(eventType, eventData) {
            switch(eventType) {
                case 'click':
                    return `<br><small>üéØ Element: ${eventData.tagName}${eventData.text ? ` - "${eventData.text.substring(0, 50)}"` : ''}</small>`;
                case 'product_view':
                case 'product_interaction':
                    return `<br><small>üì¶ Product: ${eventData.productTitle || eventData.productId || 'Unknown'}</small>`;
                case 'cart_action':
                    return `<br><small>üõí Action: ${eventData.action}${eventData.productTitle ? ` - ${eventData.productTitle}` : ''}</small>`;
                case 'checkout_step':
                    return `<br><small>üí≥ Step: ${eventData.step}</small>`;
                case 'search':
                    return `<br><small>üîç Query: "${eventData.query}"</small>`;
                case 'scroll':
                    return `<br><small>üìú Scroll: ${eventData.scrollPercent}%</small>`;
                default:
                    return '';
            }
        }

        // Sync all subscriber statuses with Shopify
        async function syncAllShopifyStatuses() {
            console.log('üîÑ Syncing all subscriber statuses with Shopify...');
            
            try {
                const response = await fetch('/api/admin/subscribers');
                const result = await response.json();
                
                if (result.success && result.data.length > 0) {
                    for (const subscriber of result.data) {
                        if (subscriber.subscription_status === 'pending') {
                            try {
                                const syncResponse = await fetch('/api/sync-shopify-status', {
                                    method: 'POST',
                                    headers: { 'Content-Type': 'application/json' },
                                    body: JSON.stringify({ email: subscriber.email })
                                });
                                
                                const syncResult = await syncResponse.json();
                                if (syncResult.success && syncResult.status === 'confirmed') {
                                    console.log('‚úÖ Updated status for:', subscriber.email);
                                }
                            } catch (syncError) {
                                console.log('‚ö†Ô∏è Failed to sync status for:', subscriber.email);
                            }
                        }
                    }
                }
            } catch (error) {
                console.log('‚ö†Ô∏è Status sync failed:', error);
            }
        }

        // Update statistics
        function updateStats() {
            const total = allSubscribers.length;
            const oneWeekAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000);
            const newThisWeek = allSubscribers.filter(sub => 
                new Date(sub.created_at) > oneWeekAgo
            ).length;
            
            const totalEvents = allSubscribers.reduce((sum, sub) => 
                sum + (sub.behavioral_events_count || 0), 0
            );
            
            const avgEngagement = total > 0 ? Math.round(totalEvents / total) : 0;

            document.getElementById('totalSubscribers').textContent = total;
            document.getElementById('newThisWeek').textContent = newThisWeek;
            document.getElementById('totalEvents').textContent = totalEvents;
            document.getElementById('avgEngagement').textContent = avgEngagement;
        }

        // Render subscribers table
        function renderSubscribersTable() {
            const tbody = document.getElementById('subscribersBody');
            const thead = document.querySelector('#subscribersTable thead');
            
            // Update table headers based on current view
            const headers = currentView === 'active' 
                ? ['Select', 'Email', 'Name', 'Status', 'Joined', 'Device', 'Location', 'Events', 'Actions']
                : ['Select', 'Email', 'Name', 'Status', 'Deleted', 'Device', 'Location', 'Events', 'Actions'];
            
            thead.innerHTML = `
                <tr>
                    <th class="checkbox-column">
                        <input type="checkbox" id="selectAll" onchange="toggleSelectAll()">
                    </th>
                    ${headers.slice(1).map(header => `<th>${header}</th>`).join('')}
                </tr>
            `;
            
            if (filteredSubscribers.length === 0) {
                const message = currentView === 'active' ? 'No active subscribers found' : 'Trash is empty';
                tbody.innerHTML = `<tr><td colspan="9" class="loading">${message}</td></tr>`;
                return;
            }

            tbody.innerHTML = filteredSubscribers.map(subscriber => `
                <tr>
                    <td class="checkbox-column">
                        <input type="checkbox" value="${subscriber.id}" onchange="toggleSubscriberSelection(${subscriber.id})" ${selectedSubscribers.has(subscriber.id) ? 'checked' : ''}>
                    </td>
                    <td>${subscriber.email}</td>
                    <td>${subscriber.first_name || 'N/A'}</td>
                    <td>
                        <span class="status-badge ${subscriber.subscription_status === 'confirmed' ? 'status-confirmed' : 'status-pending'}">
                            ${subscriber.subscription_status || 'pending'}
                        </span>
                    </td>
                    <td>${currentView === 'active' 
                        ? new Date(subscriber.created_at).toLocaleDateString()
                        : new Date(subscriber.deleted_at).toLocaleDateString()
                    }</td>
                    <td>${subscriber.device_type || 'Unknown'}</td>
                    <td>${subscriber.city ? `${subscriber.city}, ${subscriber.country}` : 'Unknown'}</td>
                    <td>${subscriber.behavioral_events_count || 0}</td>
                    <td>
                        <button class="view-details-btn" onclick="viewDetails(${subscriber.id})">
                            View Details
                        </button>
                    </td>
                </tr>
            `).join('');
            
            // Update selection UI
            updateSelectionUI();
        }

        // Search functionality
        document.getElementById('searchBox').addEventListener('input', function(e) {
            const searchTerm = e.target.value.toLowerCase();
            filteredSubscribers = allSubscribers.filter(subscriber => 
                subscriber.email.toLowerCase().includes(searchTerm) ||
                (subscriber.first_name && subscriber.first_name.toLowerCase().includes(searchTerm))
            );
            renderSubscribersTable();
        });

        // View subscriber details
        async function viewDetails(subscriberId) {
            const modal = document.getElementById('detailsModal');
            const modalContent = document.getElementById('modalContent');
            
            modal.style.display = 'block';
            modalContent.innerHTML = '<div class="loading">Loading details...</div>';

            try {
                const response = await fetch(`/api/admin/subscriber/${subscriberId}`);
                const result = await response.json();
                
                if (result.success) {
                    renderSubscriberDetails(result.data);
                } else {
                    modalContent.innerHTML = '<div class="error">Failed to load subscriber details</div>';
                }
            } catch (error) {
                console.error('Error loading details:', error);
                modalContent.innerHTML = '<div class="error">Network error occurred</div>';
            }
        }

        // Render subscriber details in modal
        function renderSubscriberDetails(data) {
            const { subscriber, deviceLocation, behavioral, pageViews } = data;
            
            const modalContent = document.getElementById('modalContent');
            modalContent.innerHTML = `
                <div class="detail-section">
                    <h3>Subscriber Information</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span>Email:</span>
                            <span>${subscriber.email}</span>
                        </div>
                        <div class="detail-item">
                            <span>Name:</span>
                            <span>${subscriber.first_name || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Status:</span>
                            <span>${subscriber.subscription_status}</span>
                        </div>
                        <div class="detail-item">
                            <span>Joined:</span>
                            <span>${new Date(subscriber.created_at).toLocaleString()}</span>
                        </div>
                        <div class="detail-item">
                            <span>IP Address:</span>
                            <span>${subscriber.ip_address === '::1' ? '127.0.0.1 (localhost)' : (subscriber.ip_address || 'N/A')}</span>
                        </div>
                        <div class="detail-item">
                            <span>Referrer:</span>
                            <span>${subscriber.referrer || 'Direct'}</span>
                        </div>
                    </div>
                </div>

                ${deviceLocation ? `
                <div class="detail-section">
                    <h3>Device & Location</h3>
                    <div class="detail-grid">
                        <div class="detail-item">
                            <span>Device Type:</span>
                            <span>${deviceLocation.device_type}</span>
                        </div>
                        <div class="detail-item">
                            <span>Browser:</span>
                            <span>${deviceLocation.browser}</span>
                        </div>
                        <div class="detail-item">
                            <span>OS:</span>
                            <span>${deviceLocation.operating_system}</span>
                        </div>
                        <div class="detail-item">
                            <span>Screen:</span>
                            <span>${deviceLocation.screen_resolution || 'N/A'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Location:</span>
                            <span>${deviceLocation.city ? `${deviceLocation.city}, ${deviceLocation.region}, ${deviceLocation.country}` : 'Unknown'}</span>
                        </div>
                        <div class="detail-item">
                            <span>Timezone:</span>
                            <span>${deviceLocation.timezone || 'N/A'}</span>
                        </div>
                    </div>
                </div>
                ` : ''}

                ${renderBehavioralAnalysis(behavioral, pageViews)}

                <div class="detail-section">
                    <h3>üìä Page Views (${pageViews.length})</h3>
                    ${pageViews.length > 0 ? pageViews.map(view => `
                        <div class="event-item">
                            <strong>üìÑ ${view.page_title || 'Untitled Page'}</strong>
                            <br>
                            <small>üîó URL: ${view.page_url}</small>
                            <br>
                            <small>üïí Time: ${new Date(view.timestamp).toLocaleString()}</small>
                            ${view.time_spent ? `<br><small>‚è±Ô∏è Time spent: ${formatTimeSpent(view.time_spent)}</small>` : ''}
                            ${view.referrer ? `<br><small>üëÜ Referrer: ${view.referrer}</small>` : ''}
                        </div>
                    `).join('') : '<p>No page views recorded yet. Page views are tracked after newsletter signup.</p>'}
                </div>

                <div class="detail-section">
                    <h3>üéØ Interaction Events (${behavioral.length})</h3>
                    ${behavioral.length > 0 ? renderCategorizedEvents(behavioral) : '<p>No interaction events recorded</p>'}
                </div>
            `;
        }

        // Export data as CSV
        function exportData() {
            const csvContent = [
                ['Email', 'Name', 'Status', 'Joined', 'Device', 'Browser', 'Location', 'Events', 'Page Views'],
                ...filteredSubscribers.map(sub => [
                    sub.email,
                    sub.first_name || '',
                    sub.subscription_status || 'pending',
                    new Date(sub.created_at).toISOString(),
                    sub.device_type || '',
                    sub.browser || '',
                    sub.city ? `${sub.city}, ${sub.country}` : '',
                    sub.behavioral_events_count || 0,
                    sub.page_views_count || 0
                ])
            ].map(row => row.map(field => `"${field}"`).join(',')).join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `newsletter-subscribers-${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // Show error message
        function showError(message) {
            const tbody = document.getElementById('subscribersBody');
            tbody.innerHTML = `<tr><td colspan="8" class="error">${message}</td></tr>`;
        }

        // Modal functionality
        const modal = document.getElementById('detailsModal');
        const closeBtn = document.querySelector('.close');

        closeBtn.onclick = function() {
            modal.style.display = 'none';
        }

        window.onclick = function(event) {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        }

        // Manual sync function
        async function syncAllStatuses() {
            console.log('üîÑ Manual sync triggered...');
            
            // Show loading state
            const syncButton = document.querySelector('button[onclick="syncAllStatuses()"]');
            const originalText = syncButton.textContent;
            syncButton.textContent = 'Syncing...';
            syncButton.disabled = true;
            
            let updated = 0;
            
            try {
                for (const subscriber of allSubscribers) {
                    console.log('üîç Checking:', subscriber.email);
                    
                    try {
                        const syncResponse = await fetch('/api/sync-shopify-status', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ email: subscriber.email })
                        });
                        
                        const syncResult = await syncResponse.json();
                        console.log('üìä Sync result for', subscriber.email, ':', syncResult);
                        
                        if (syncResult.success && syncResult.updated) {
                            updated++;
                            console.log('‚úÖ Updated:', subscriber.email, 'to', syncResult.status);
                        }
                        
                        // Small delay to avoid rate limiting
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (syncError) {
                        console.log('‚ö†Ô∏è Failed to sync:', subscriber.email, syncError);
                    }
                }
                
                alert(`Sync complete! Updated ${updated} subscriber(s).`);
                
                // Reload the dashboard
                loadDashboard();
                
            } catch (error) {
                console.error('‚ùå Sync failed:', error);
                alert('Sync failed. Check console for details.');
            } finally {
                syncButton.textContent = originalText;
                syncButton.disabled = false;
            }
        }

        // Delete subscriber (soft delete - move to trash)
        async function deleteSubscriber(subscriberId) {
            if (!confirm('Are you sure you want to move this subscriber to trash? This will not affect the Shopify customer.')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/subscriber/${subscriberId}`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Subscriber moved to trash successfully!');
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to delete subscriber: ' + result.message);
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Network error occurred while deleting subscriber');
            }
        }

        // Restore subscriber from trash
        async function restoreSubscriber(subscriberId) {
            if (!confirm('Are you sure you want to restore this subscriber?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/subscriber/${subscriberId}/restore`, {
                    method: 'POST'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Subscriber restored successfully!');
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to restore subscriber: ' + result.message);
                }
            } catch (error) {
                console.error('Restore error:', error);
                alert('Network error occurred while restoring subscriber');
            }
        }

        // Permanently delete subscriber
        async function permanentlyDeleteSubscriber(subscriberId) {
            if (!confirm('‚ö†Ô∏è WARNING: This will PERMANENTLY delete the subscriber and ALL their data. This action cannot be undone. Are you sure?')) {
                return;
            }
            
            if (!confirm('This is your final warning. The subscriber and all their behavioral data will be permanently deleted. Continue?')) {
                return;
            }
            
            try {
                const response = await fetch(`/api/admin/subscriber/${subscriberId}/permanent`, {
                    method: 'DELETE'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert('Subscriber permanently deleted!');
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to permanently delete subscriber: ' + result.message);
                }
            } catch (error) {
                console.error('Permanent delete error:', error);
                alert('Network error occurred while permanently deleting subscriber');
            }
        }

        // Bulk delete selected subscribers
        async function bulkDeleteSelected() {
            const selectedIds = Array.from(selectedSubscribers);
            const count = selectedIds.length;
            
            if (count === 0) {
                alert('No subscribers selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to move ${count} subscriber(s) to trash? This will not affect Shopify customers.`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/subscribers/bulk-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriberIds: selectedIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully moved ${result.deletedCount} subscriber(s) to trash!`);
                    selectedSubscribers.clear();
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to delete subscribers: ' + result.message);
                }
            } catch (error) {
                console.error('Bulk delete error:', error);
                alert('Network error occurred while deleting subscribers');
            }
        }

        // Bulk restore selected subscribers
        async function bulkRestoreSelected() {
            const selectedIds = Array.from(selectedSubscribers);
            const count = selectedIds.length;
            
            if (count === 0) {
                alert('No subscribers selected');
                return;
            }
            
            if (!confirm(`Are you sure you want to restore ${count} subscriber(s) from trash?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/subscribers/bulk-restore', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriberIds: selectedIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully restored ${result.restoredCount} subscriber(s)!`);
                    selectedSubscribers.clear();
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to restore subscribers: ' + result.message);
                }
            } catch (error) {
                console.error('Bulk restore error:', error);
                alert('Network error occurred while restoring subscribers');
            }
        }

        // Bulk permanently delete selected subscribers
        async function bulkPermanentDeleteSelected() {
            const selectedIds = Array.from(selectedSubscribers);
            const count = selectedIds.length;
            
            if (count === 0) {
                alert('No subscribers selected');
                return;
            }
            
            if (!confirm(`‚ö†Ô∏è WARNING: This will PERMANENTLY delete ${count} subscriber(s) and ALL their data. This action cannot be undone. Are you sure?`)) {
                return;
            }
            
            if (!confirm(`This is your final warning. ${count} subscriber(s) and all their behavioral data will be permanently deleted. Continue?`)) {
                return;
            }
            
            try {
                const response = await fetch('/api/admin/subscribers/bulk-permanent-delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ subscriberIds: selectedIds })
                });
                
                const result = await response.json();
                
                if (result.success) {
                    alert(`Successfully permanently deleted ${result.deletedCount} subscriber(s)!`);
                    selectedSubscribers.clear();
                    loadDashboard(); // Refresh the table
                } else {
                    alert('Failed to permanently delete subscribers: ' + result.message);
                }
            } catch (error) {
                console.error('Bulk permanent delete error:', error);
                alert('Network error occurred while permanently deleting subscribers');
            }
        }

        // Initialize dashboard
        loadDashboard();

        // Refresh data every 30 seconds
        setInterval(loadDashboard, 30000);
    </script>
</body>
</html>